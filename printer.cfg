## DO NOT EDIT THIS FILE, IT IS A TEMPLATE.
# Rat Rig V-core 3 Klipper Config

# The first thing you'll need to do is go through this file and comment out / uncomment 
# the files and/or settings you need.
# You'll be able to print just fine with this config as it is, but it is recommended
# that you follow these steps to properly calibrate your printer:
# 0) Sanity check and PID Tuning: https://www.klipper3d.org/Config_checks.html
# 1) Pressure Advance: https://www.klipper3d.org/Pressure_Advance.html
# 2) Skew Correction: https://www.klipper3d.org/skew_correction.html
# 3) Resonance Compensation: https://www.klipper3d.org/Resonance_Compensation.html

# Read more about klipper here: https://www.klipper3d.org/Overview.html

### CONTROL BOARD
#[include config/boards/btt-skr-pro-12/config.cfg]
[include config/boards/btt-octopus-11/config.cfg]


### BASE SETUP
[include config/printers/v-core-3/v-core-3.cfg]
[include config/printers/v-core-3/steppers.cfg]
[include config/printers/v-core-3/tmc2209.cfg]

### Stepper mechanical overrides
[stepper_x]
dir_pin: x_dir_pin # Add ! in front of pin name to reverse X stepper direction
rotation_distance: 40 # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys

[stepper_y]
dir_pin: y_dir_pin # Add ! in front of pin name to reverse Y stepper direction
rotation_distance: 40 # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys

[stepper_z]
dir_pin: z0_dir_pin # Add ! in front of pin name to reverse Z stepper direction
rotation_distance: 4 # 4 for TR8*4 lead screws

[stepper_z1]
dir_pin: z1_dir_pin # Add ! in front of pin name to reverse Z1 direction
rotation_distance: 4 # 4 for TR8*4 lead screws

[stepper_z2]
dir_pin: z2_dir_pin # Add ! in front of pin name to reverse Z2 direction
rotation_distance: 4 # 4 for TR8*4 lead screws

[extruder]
dir_pin: !e_dir_pin # Remove ! in front of pin name to reverse extruder direction
nozzle_diameter: 0.4

# Uncomment this next line if you have an ADXL345 connected to the SKR PRO
[include config/sensors/adxl345.cfg] 

### HOMING
# BL Touch
[include config/z-probe/bltouch.cfg]
[bltouch]
#z_offset: 4.0 # Adjust this to fit your setup

# Inductive/Capacitive probe
#[include config/z-probe/probe.cfg]
#[probe]
#z_offset: 0.0 # Adjust this to fit your setup
#pin: ^!probe_pin # Change this to suit your probe (NPN/PNP NO/NC) if necessary.

# Physical endstops
#[include config/printers/v-core-3/physical-endstops.cfg]
#[safe_z_home]
#home_xy_position: 150,150 # 300mm printer
#home_xy_position: 200,200 # 400mm printer
#home_xy_position: 250,250 # 500mm printer

# Endstop position
# Adjust this to your setup
# Note: might need fine tuning.
#[stepper_y]
#position_endstop: 300  # 300mm printer
#position_endstop: 400 # 400mm printer
#position_endstop: 500 # 500mm printer
#[stepper_x]
#position_endstop: 0

# Sensorless homing (Beware: this requires manual tinkering and does not work if your x/y stepper drivers
# have clipped DIAG pins). It is strongly encouraged to use physical endstops if you're a beginner.
# If you still wish to proceed, copy config/templates/sensorless-homing.cfg to the root directory and 
# remove the # from the line below.
[include sensorless-homing.cfg]

### PHYSICAL DIMENSIONS
# Remove the # from your printer size below. 
# Similarly add a # in front of [include config/printers/v-core-3/300.cfg] if you have a bigger machine.
[include config/printers/v-core-3/300.cfg]
#[include config/printers/v-core-3/400.cfg]
#[include config/printers/v-core-3/500.cfg]

### SPEED & ACCEL
# Acceleration
# Check https://www.klipper3d.org/Resonance_Compensation.html for input shaper calibration.
[include config/printers/v-core-3/speed-limits-basic.cfg]
# Do not enable this next line without actively cooled stepper drivers.
#[include config/printers/v-core-3/speed-limits-performance.cfg]


### EXTRUSION

# Extruder
#[include config/extruders/bmg.cfg]
# [include config/extruders/lgx.cfg]
[include config/extruders/orbiter.cfg]
#[include config/extruders/hemera.cfg]
# [include config/extruders/titan.cfg]

# Hotend
[include config/hotends/v6.cfg]
# [include config/hotends/copperhead.cfg]
# [include config/hotends/mosquito.cfg]
# [include config/hotends/mosquito-magnum.cfg]
# [include config/hotends/dragon-standard-flow.cfg]
# [include config/hotends/dragon-high-flow.cfg]

# Pressure Advance
# Check https://www.klipper3d.org/Pressure_Advance.html for pressure advance tuning.
[extruder]
rotation_distance: 4.81
#pressure_advance: 0.05

### HOTEND HEATING
# PID Tuning (Remember to run PID tuning before printing)
#control: pid
#pid_kp: 28.413
#pid_ki: 1.334
#pid_kd: 151.300

### BED HEATING
# BED PID Tuning (Remember to run PID tuning before printing)
[heater_bed]
#control: pid
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 114

### MACROS
[include config/macros.cfg]
[include config/printers/v-core-3/macros.cfg]


### USER OVERRIDES
# Place all your overrides here

[display]
lcd_type: st7920
cs_pin: EXP1_4
sclk_pin: EXP1_5
sid_pin: EXP1_3
encoder_pins: ^EXP2_3, ^EXP2_5
click_pin: ^!EXP1_2
#kill_pin: ^!EXP2_8

[output_pin beeper]
pin: EXP1_1



[force_move]
enable_force_move: True

[resonance_tester]
accel_chip: adxl345
probe_points:
    150,150,20 # Override this in printer.cfg to be the center of your bed.

[stepper_x]
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_min: -12
position_endstop: -12

[stepper_y]
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_min: -12
position_endstop: -5

[tmc2209 stepper_x]
diag_pin: x_diag_pin
driver_SGTHRS: 60 # Stall guard threshold, this is your X sensitivity, to adjust, copy this section and override it in printer.cfg.

[tmc2209 stepper_y]
diag_pin: y_diag_pin
driver_SGTHRS: 60 # Stall guard threshold, this is your Y sensitivity, to adjust, copy this section and override it in printer.cfg.

[homing_override]
set_position_z: 5
gcode:
    M400                  # Wait for moves to finish
    G90                   # Absolute positioning
    G0 Z10 F600           # Hop Z-Axis
    M204 S1000            # Set homing acceleration (important!)

    # Home Y
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT=0.9 HOLDCURRENT=0.4
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT=0.9 HOLDCURRENT=0.4
    G28 Y
    G0 Y{printer.toolhead.axis_maximum.y / 2} F9000

    # Home X
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT=0.9 HOLDCURRENT=0.5
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT=0.9 HOLDCURRENT=0.5
    G28 X

    G0 X{printer.toolhead.axis_maximum.x / 2} F9000
 
    # Restore current
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config["tmc2209 stepper_x"].run_current} HOLDCURRENT={printer.configfile.config["tmc2209 stepper_x"].hold_current}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config["tmc2209 stepper_y"].run_current} HOLDCURRENT={printer.configfile.config["tmc2209 stepper_y"].hold_current}

	G0 X{printer.toolhead.axis_maximum.x / 2} Y{printer.toolhead.axis_maximum.y / 2} F3000
	
    # Rehome Z
    G28 Z
    
    # Safe Z
    G0 Z10 F600

[extruder]
step_pin: e_step_pin
dir_pin:  !e_dir_pin
enable_pin: !e_enable_pin
microsteps: 16

[gcode_macro m205]
gcode:

#[bltouch]
#samples: 2

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.085644, 0.096894, -0.026856, -0.114356, -0.041856, -0.001856, 0.031894
#*# 	  -0.019356, 0.003144, -0.008106, -0.083106, -0.014356, 0.008144, 0.024394
#*# 	  0.043144, -0.004356, 0.034394, -0.053106, -0.076856, 0.028144, 0.069394
#*# 	  0.045644, 0.049394, -0.041856, -0.045606, -0.041856, 0.011894, 0.073144
#*# 	  0.053144, 0.118144, 0.008144, -0.011856, 0.009394, 0.040644, 0.094394
#*# 	  0.143144, 0.093144, 0.028144, -0.044356, -0.015606, 0.080644, 0.110644
#*# 	  0.130644, 0.103144, 0.104394, 0.039394, 0.019394, 0.080644, 0.136894
#*# tension = 0.2
#*# min_x = 20.0
#*# algo = bicubic
#*# y_count = 7
#*# mesh_y_pps = 2
#*# min_y = 20.0
#*# x_count = 7
#*# max_y = 260.0
#*# mesh_x_pps = 2
#*# max_x = 264.98
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 53.529
#*# pid_ki = 2.549
#*# pid_kd = 281.025
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 34.998
#*# pid_ki = 4.964
#*# pid_kd = 61.683
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 69.2
#*# shaper_type_y = zv
#*# shaper_freq_y = 68.6
#*#
#*# [bltouch]
#*# z_offset = 1.25
